[CmdletBinding()]
param(
  [string]$LinuxScript = "~/flash_nano.sh",
  [string]$Distro = "",
  [string[]]$HardwareIds = @("0955:7f21"),
  [int]$PollSeconds = 1,
  [bool]$StopWhenScriptEnds = $true
)

function Ensure-Admin {
  $id = [Security.Principal.WindowsIdentity]::GetCurrent()
  $p  = New-Object Security.Principal.WindowsPrincipal($id)
  if (-not $p.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
    $psi = New-Object System.Diagnostics.ProcessStartInfo "powershell";
    $psi.Arguments = "-ExecutionPolicy Bypass -File `"$PSCommandPath`" " + ($MyInvocation.UnboundArguments -join ' ')
    $psi.Verb = "runas"
    [Diagnostics.Process]::Start($psi) | Out-Null
    exit
  }
}

function Parse-UsbipdList {
  # Returns objects: BusId, VidPid, Name, StateRaw, IsShared, IsAttachedToWSL
  $out = usbipd list 2>$null
  if (-not $out) { return @() }
  $items = @()

  foreach ($line in $out) {
    # Robustly capture: BUSID, VID:PID, NAME (e.g., APX), STATE (e.g., Shared (forced) / Attached - WSL / Not shared)
    $m = [regex]::Match(
      $line,
      '^\s*(?<busid>\d+(?:-\d+)+)\s+(?<vidpid>[0-9A-Fa-f]{4}:[0-9A-Fa-f]{4})\s+(?<name>.+?)\s{2,}(?<state>.+?)\s*$'
    )
    if ($m.Success) {
      $state = $m.Groups['state'].Value
      $items += [pscustomobject]@{
        BusId          = $m.Groups['busid'].Value
        VidPid         = $m.Groups['vidpid'].Value.ToLower()
        Name           = $m.Groups['name'].Value.Trim()
        StateRaw       = $state
        IsShared       = ($state -like 'Shared*') -or ($state -like 'Attached*')
        IsAttachedToWSL= ($state -like 'Attached - WSL*')
      }
    }
  }
  return $items
}

function Find-MatchingDevices {
  param([string[]]$Hids)
  $all = Parse-UsbipdList
  if (-not $all) { return @() }
  $want = $Hids | ForEach-Object { $_.ToLower() }
  return $all | Where-Object { $want -contains $_.VidPid }
}

function Bind-Attach-IfNeeded {
  param($dev)
  if (-not $dev) { return $false }
  $changed = $false

  # Ensure device is shared (bound). "Shared (forced)" and "Attached - WSL" both count as shared.
  if (-not $dev.IsShared) {
    & usbipd bind --busid $dev.BusId --force 2>$null | Out-Null
    $changed = $true
  } else {
    # Still try to refresh share in case it flipped states during re-enum; ignore errors.
    & usbipd bind --busid $dev.BusId --force 2>$null | Out-Null
  }

  # Ensure attached to WSL
  if (-not $dev.IsAttachedToWSL) {
    & usbipd attach --wsl --busid $dev.BusId 2>$null | Out-Null
    $changed = $true
  }
  return $changed
}

# --- Main ---
Ensure-Admin
Write-Host "Polling for Jetson (VID:PID = $($HardwareIds -join ', ')) without auto-attach..." -ForegroundColor Cyan

$scriptStarted = $false
$wslProc = $null

while ($true) {
  $matches = Find-MatchingDevices -Hids $HardwareIds

  if ($matches.Count -gt 0) {
    # Prefer something already attached to WSL, else first match
    $dev = ($matches | Where-Object {$_.IsAttachedToWSL} | Select-Object -First 1)
    if (-not $dev) { $dev = $matches[0] }

    $did = Bind-Attach-IfNeeded -dev $dev
    if ($did -or $dev.IsAttachedToWSL) {
      Write-Host ("OK: {0} {1}  [{2}]" -f $dev.BusId, $dev.VidPid, $dev.StateRaw) -ForegroundColor Green
    }

    if (-not $scriptStarted -and ($dev.IsAttachedToWSL -or $did)) {
      $scriptStarted = $true
      $wslCmd = if ($Distro) {
        @("wsl.exe","-d",$Distro,"--","bash","-lc",$LinuxScript)
      } else {
        @("wsl.exe","--","bash","-lc",$LinuxScript)
      }
      Write-Host "Launching inside WSL: $LinuxScript" -ForegroundColor Cyan
      $wslProc = Start-Process -PassThru -NoNewWindow -FilePath $wslCmd[0] -ArgumentList $wslCmd[1..($wslCmd.Count-1)]
    }
  } else {
    Write-Host "Waiting for Jetson APX... (hold RECOVERY and plug USB)" -ForegroundColor DarkGray
  }

  if ($StopWhenScriptEnds -and $scriptStarted -and $wslProc -and $wslProc.HasExited) {
    Write-Host "WSL script ended (exit $($wslProc.ExitCode)). Stopping poller." -ForegroundColor Yellow
    break
  }

  Start-Sleep -Seconds $PollSeconds
}
